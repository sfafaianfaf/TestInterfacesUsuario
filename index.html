<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPO ¬∑ Test MIX</title>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--text:#e7eefc;--muted:#9aa4b2;--border:#24304a;
      --accent:#6ea8fe;--ok:#57d18a;--bad:#ff6b6b;--warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #132044 0%, var(--bg) 60%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 14px 48px;}
    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{border:1px solid var(--border);color:var(--muted);padding:3px 10px;border-radius:999px;font-size:12px}
    .card{
      margin-top:14px; border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,26,43,.92), rgba(18,26,43,.7));
      border-radius:16px; padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select, input[type="number"]{
      background:#0b1220;color:var(--text);border:1px solid var(--border);
      padding:10px 10px;border-radius:12px;outline:none;
    }
    button, a.home{
      background:rgba(110,168,254,.16);
      color:var(--text);border:1px solid rgba(110,168,254,.45);
      padding:10px 12px;border-radius:12px;cursor:pointer;
      font-weight:800;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      text-decoration:none;
      display:inline-block;
      text-align:center;
    }
    button.primary{background:rgba(110,168,254,.85); color:#06101f; border-color:rgba(110,168,254,.85)}
    button.good{background:rgba(87,209,138,.20); border-color:rgba(87,209,138,.55)}
    a.home{background:transparent;border-color:var(--border);color:var(--muted)}
    a.home:hover{border-color: rgba(110,168,254,.55); background: rgba(110,168,254,.10); color:var(--text)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .qhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .qmeta{color:var(--muted);font-size:12px}
    .qtext{margin:10px 0 10px;font-size:16px;line-height:1.35}
    .opts{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
    .opt{
      border:1px solid var(--border);
      background: rgba(11,18,32,.55);
      border-radius:14px;
      padding:10px 10px;
      display:flex;gap:10px;align-items:flex-start;
    }
    .opt input{margin-top:3px;transform:scale(1.15)}
    .opt .txt{font-size:14px;line-height:1.3}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .feedback{
      margin-top:10px; border-radius:14px; padding:10px 12px; font-size:13px; line-height:1.35;
      border:1px solid var(--border); background: rgba(11,18,32,.55);
    }
    .feedback.ok{border-color:rgba(87,209,138,.55); background: rgba(87,209,138,.10)}
    .feedback.bad{border-color:rgba(255,107,107,.55); background: rgba(255,107,107,.10)}
    .feedback.warn{border-color:rgba(255,209,102,.55); background: rgba(255,209,102,.10)}
    .hr{height:1px;background:rgba(36,48,74,.7);margin:14px 0}
    details.reviewItem{
      border:1px solid var(--border); border-radius:14px; padding:10px 12px;
      background: rgba(11,18,32,.55); margin-top:10px;
    }
    summary{cursor:pointer;font-weight:900}
    .small{color:var(--muted);font-size:12px}
    .tag{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:8px;color:var(--muted);font-size:12px}
    .ans{margin-top:8px;font-size:13px;line-height:1.35}
    .okText{color:var(--ok);font-weight:900}
    .badText{color:var(--bad);font-weight:900}
    .warnText{color:var(--warn);font-weight:900}
    @media (max-width:720px){
      button,a.home{width:100%}
      .bar{flex-direction:column;align-items:stretch}
      .qhead{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>IPO ¬∑ Test MIX</h1>
      <p class="sub">
        Mezcla: 20 del Tema 1, 20 del Tema 2, 20 del Tema 3, y 10 de los Temas 4, 5 y 6.
        Puntuaci√≥n: +1 / ‚àí1/3 / 0. Aleatorio.
      </p>
      <div class="pillrow">
        <span class="pill">90 preguntas</span>
        <span class="pill">Aleatorio</span>
        <span class="pill">Revisi√≥n final</span>
      </div>
    </div>
    <a class="home" href="index.html">üè† Men√∫</a>
  </div>

  <div id="setup" class="card">
    <div class="row">
      <div>
        <label>Modo</label><br/>
        <select id="seed">
          <option value="random" selected>Barajar cada vez</option>
          <option value="fixed">Orden fijo (para repetir)</option>
        </select>
      </div>
      <div style="flex:1"></div>
      <div>
        <button id="btnStart" class="primary">Empezar test MIX</button>
      </div>
    </div>
    <div class="small" style="margin-top:10px">
      Nota: este MIX necesita que pegues aqu√≠ dentro los bancos de preguntas de cada tema (T1..T6).
    </div>
  </div>

  <div id="quiz" class="card" style="display:none;">
    <div class="qhead">
      <div class="qmeta" id="qmeta">Pregunta 1/90</div>
      <div class="qmeta" id="scoreLive">Aciertos: 0 ¬∑ Fallos: 0 ¬∑ En blanco: 0 ¬∑ Nota: 0.00</div>
    </div>

    <div class="qtext" id="qtext"></div>
    <div class="opts" id="opts"></div>

    <div class="bar">
      <a class="home" href="index.html">üè† Men√∫</a>
      <button id="btnPrev">‚¨ÖÔ∏è Atr√°s</button>
      <button id="btnNext">Siguiente ‚û°Ô∏è</button>
      <div style="flex:1"></div>
      <button id="btnSkip">Dejar en blanco</button>
      <button id="btnConfirm" class="primary">Confirmar respuesta</button>
      <button id="btnFinish" class="good">Finalizar test</button>
    </div>

    <div id="feedback" class="feedback" style="display:none;"></div>
  </div>

  <div id="results" class="card" style="display:none;">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Resultados</h2>
      <a class="home" href="index.html">üè† Men√∫</a>
    </div>
    <div class="qmeta" id="finalLine"></div>
    <div class="hr"></div>
    <div class="bar">
      <button id="btnExpandAll">Expandir todo</button>
      <button id="btnCollapseAll">Colapsar todo</button>
      <div style="flex:1"></div>
      <button id="btnBackToSetup" class="primary">Repetir MIX</button>
    </div>
    <div id="review"></div>
  </div>
</div>

<script>
/* ===== util ===== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function onClick(id, fn){
  document.getElementById(id).addEventListener("click", (e)=>{ e.preventDefault(); fn(); });
}

/* =========================================================
   Pega aqu√≠ los bancos reales de cada tema.
   Estructura: {q:"...", a:["...","...","...","..."], c:0..3, e:"explicaci√≥n opcional"}
========================================================= */
const BANK_T1 = [
  // üîß PEGA AQU√ç las preguntas del Tema 1
];
const BANK_T2 = [
  // üîß PEGA AQU√ç las preguntas del Tema 2
];
const BANK_T3 = [
  // üîß PEGA AQU√ç las preguntas del Tema 3
];
const BANK_T4 = [
  // üîß PEGA AQU√ç las preguntas del Tema 4
];
const BANK_T5 = [
  // üîß PEGA AQU√ç las preguntas del Tema 5
];
const BANK_T6 = [
  // üîß PEGA AQU√ç las preguntas del Tema 6
];

/* ===== build MIX ===== */
function pickN(bank, n, fixed){
  const pool = fixed ? bank.slice() : shuffle(bank);
  return pool.slice(0, Math.min(n, pool.length));
}

let session = [];
let answers = [];
let idx = 0;
let fixedOrder = false;

/* ===== DOM ===== */
const setupEl = document.getElementById("setup");
const quizEl = document.getElementById("quiz");
const resultsEl = document.getElementById("results");
const seedEl = document.getElementById("seed");

const qmetaEl = document.getElementById("qmeta");
const scoreLiveEl = document.getElementById("scoreLive");
const qtextEl = document.getElementById("qtext");
const optsEl = document.getElementById("opts");
const feedbackEl = document.getElementById("feedback");

const finalLineEl = document.getElementById("finalLine");
const reviewEl = document.getElementById("review");

function buildSession(){
  fixedOrder = (seedEl.value === "fixed");

  const part1 = pickN(BANK_T1, 20, fixedOrder).map(x=>({...x, topic:"Tema 1"}));
  const part2 = pickN(BANK_T2, 20, fixedOrder).map(x=>({...x, topic:"Tema 2"}));
  const part3 = pickN(BANK_T3, 20, fixedOrder).map(x=>({...x, topic:"Tema 3"}));
  const part4 = pickN(BANK_T4, 10, fixedOrder).map(x=>({...x, topic:"Tema 4"}));
  const part5 = pickN(BANK_T5, 10, fixedOrder).map(x=>({...x, topic:"Tema 5"}));
  const part6 = pickN(BANK_T6, 10, fixedOrder).map(x=>({...x, topic:"Tema 6"}));

  let picked = [...part1,...part2,...part3,...part4,...part5,...part6];
  picked = fixedOrder ? picked : shuffle(picked);

  // barajar opciones y recalcular correcta
  session = picked.map(item => {
    const options = item.a.map((txt, i) => ({txt, origIndex:i}));
    const mixed = fixedOrder ? options : shuffle(options);
    const newCorrect = mixed.findIndex(o => o.origIndex === item.c);
    return {
      topic: item.topic,
      q: item.q,
      opts: mixed.map(o => o.txt),
      correct: newCorrect,
      explain: item.e || ""
    };
  });

  answers = session.map(_ => ({
    sel: null,
    graded: false,
    isBlank: true,
    isCorrect: false,
    points: 0
  }));

  idx = 0;
}

function renderQuestion(){
  const total = session.length;
  const item = session[idx];

  qmetaEl.textContent = `Pregunta ${idx+1}/${total} ¬∑ ${item.topic}`;
  qtextEl.textContent = item.q;

  optsEl.innerHTML = "";
  const name = `q_${idx}`;
  item.opts.forEach((txt, i) => {
    const lab = document.createElement("label");
    lab.className = "opt";
    lab.innerHTML = `
      <input type="radio" name="${name}" value="${i}" />
      <div class="txt"><b>${String.fromCharCode(65+i)})</b> ${escapeHtml(txt)}</div>
    `;
    optsEl.appendChild(lab);
  });

  if(answers[idx].sel !== null){
    const r = optsEl.querySelector(`input[value="${answers[idx].sel}"]`);
    if(r) r.checked = true;
  }

  feedbackEl.style.display = "none";
  feedbackEl.className = "feedback";

  document.getElementById("btnPrev").disabled = (idx === 0);
  document.getElementById("btnNext").disabled = (idx === total-1);

  updateLiveScore();
}

function saveSelectionFromUI(){
  const checked = optsEl.querySelector('input[type="radio"]:checked');
  if(checked){
    answers[idx].sel = parseInt(checked.value,10);
    answers[idx].isBlank = false;
  }else{
    answers[idx].sel = null;
    answers[idx].isBlank = true;
  }
}

function showFeedback(kind, title, html){
  feedbackEl.style.display = "block";
  feedbackEl.className = `feedback ${kind}`;
  feedbackEl.innerHTML = `<b>${title}</b><div class="small" style="margin-top:4px">${html}</div>`;
}

function gradeCurrent(forceBlank){
  if(forceBlank){
    answers[idx].sel = null;
    answers[idx].isBlank = true;
  }else{
    saveSelectionFromUI();
  }

  const item = session[idx];
  const a = answers[idx];

  if(a.isBlank){
    a.graded = true;
    a.isCorrect = false;
    a.points = 0;
    showFeedback("warn", "En blanco", `No suma ni resta. Correcta: <b>${String.fromCharCode(65+item.correct)})</b> ${escapeHtml(item.opts[item.correct])}`);
  }else{
    a.graded = true;
    a.isCorrect = (a.sel === item.correct);
    a.points = a.isCorrect ? 1 : (-1/3);
    showFeedback(a.isCorrect ? "ok" : "bad",
      a.isCorrect ? "Correcta ‚úÖ" : "Incorrecta ‚ùå",
      `Correcta: <b>${String.fromCharCode(65+item.correct)})</b> ${escapeHtml(item.opts[item.correct])}<br/><span class="small">${escapeHtml(item.explain)}</span>`
    );
  }

  updateLiveScore();
}

function computeScore(){
  let ok=0, bad=0, blank=0, points=0;
  answers.forEach(a=>{
    if(a.isBlank){ blank++; }
    else if(a.isCorrect){ ok++; }
    else { bad++; }
    points += a.points;
  });
  return {ok,bad,blank,points};
}

function updateLiveScore(){
  const s = computeScore();
  scoreLiveEl.textContent = `Aciertos: ${s.ok} ¬∑ Fallos: ${s.bad} ¬∑ En blanco: ${s.blank} ¬∑ Nota: ${fmt(s.points)}`;
}

function finish(){
  const s = computeScore();
  quizEl.style.display = "none";
  resultsEl.style.display = "block";
  finalLineEl.innerHTML = `
    <span class="okText">Aciertos:</span> ${s.ok} ¬∑
    <span class="badText">Fallos:</span> ${s.bad} ¬∑
    <span class="warnText">En blanco:</span> ${s.blank} ¬∑
    <b>Nota final:</b> ${fmt(s.points)}
    <span class="tag">+1 / ‚àí0.33 / 0</span>
  `;

  reviewEl.innerHTML = "";
  session.forEach((item, i) => {
    const a = answers[i];
    const status = a.isBlank ? "En blanco" : (a.isCorrect ? "Correcta" : "Incorrecta");
    const statusClass = a.isBlank ? "warnText" : (a.isCorrect ? "okText" : "badText");
    const selTxt = a.isBlank ? "‚Äî" : `${String.fromCharCode(65+a.sel)}) ${item.opts[a.sel]}`;
    const corTxt = `${String.fromCharCode(65+item.correct)}) ${item.opts[item.correct]}`;

    const det = document.createElement("details");
    det.className = "reviewItem";
    det.innerHTML = `
      <summary>Pregunta ${i+1}: <span class="${statusClass}">${status}</span> <span class="tag">${fmt(a.points)} pts</span></summary>
      <div class="ans small"><b>${escapeHtml(item.topic)}</b></div>
      <div class="ans"><b>Enunciado:</b> ${escapeHtml(item.q)}</div>
      <div class="ans"><b>Tu respuesta:</b> ${escapeHtml(selTxt)}</div>
      <div class="ans"><b>Correcta:</b> ${escapeHtml(corTxt)}</div>
      ${item.explain ? `<div class="ans small"><b>Nota:</b> ${escapeHtml(item.explain)}</div>` : ``}
    `;
    reviewEl.appendChild(det);
  });
}

function hardReset(){
  resultsEl.style.display = "none";
  quizEl.style.display = "none";
  setupEl.style.display = "block";
  feedbackEl.style.display = "none";
}

/* ===== eventos ===== */
onClick("btnStart", ()=>{
  buildSession();
  setupEl.style.display = "none";
  resultsEl.style.display = "none";
  quizEl.style.display = "block";
  renderQuestion();
});
onClick("btnPrev", ()=>{
  saveSelectionFromUI();
  if(idx>0){ idx--; renderQuestion(); }
});
onClick("btnNext", ()=>{
  saveSelectionFromUI();
  if(idx<session.length-1){ idx++; renderQuestion(); }
});
onClick("btnConfirm", ()=> gradeCurrent(false));
onClick("btnSkip", ()=> gradeCurrent(true));
onClick("btnFinish", finish);
onClick("btnExpandAll", ()=> document.querySelectorAll("details.reviewItem").forEach(d=> d.open = true));
onClick("btnCollapseAll", ()=> document.querySelectorAll("details.reviewItem").forEach(d=> d.open = false));
onClick("btnBackToSetup", hardReset);
</script>
</body>
</html>
